#!/bin/bash
#Include enviroment variables
. $(cd `dirname "${BASH_SOURCE[0]}"` && pwd)/subutai.env
mng_vlan=$MNG_VLAN
if [ "$mng_vlan" == "" ]; then
        mng_vlan=200
fi
 
#iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 

mkdir -p /var/run/openvswitch/

while [ "`ip link | grep 'wan' | wc -l`" -eq "0" ]; do
	sleep 1
	ovs-vsctl --may-exist add-br wan
done
ovs-vsctl set bridge wan other-config:hwaddr=$(ip link show eth0 | grep ether | awk '{print $2}')
ovs-vsctl --may-exist add-port wan eth0
ifconfig eth0 0 && dhclient wan
if [ "$AUTOBUILD_IP" != "" ]; then
	echo $(ifconfig wan | grep 'inet addr' | awk -F: '{print $2}' | awk '{print $1}') | nc $AUTOBUILD_IP 48723
fi
cat <<EOF > /writable/system-data/etc/network/interfaces.d/eth0
auto eth0
iface eth0 inet manual
EOF
systemctl restart ifup@eth0
ovs-vsctl --may-exist add-port wan mng-net -- set interface mng-net type=internal
ovs-vsctl set port mng-net tag=$mng_vlan

while [ "`ip link | grep 'nat' | wc -l`" -eq "0" ]; do
        sleep 1
        ovs-vsctl --may-exist add-br lxc-br
	ovs-vsctl --may-exist add-port lxc-br nat -- set interface nat type=internal
done

while [ "$( ifconfig -s | grep -c nat )" != "1" ]; do
	ifconfig nat 10.10.0.254/24
        sleep 1
done

iptables -t nat -A POSTROUTING -j MASQUERADE
ifup -a --allow=env
dhclient mng-net

#$SUBUTAI_DATA_PREFIX/var/subutai-network/service-interface start
