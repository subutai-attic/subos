#!/bin/bash
#Include enviroment variables
. $(cd `dirname "${BASH_SOURCE[0]}"` && pwd)/subutai.env

MNG_VLAN="$(cat $SUBUTAI_DATA_PREFIX/vlan)"
if [ "$MNG_VLAN" == "" ]; then
        MNG_VLAN=2
	echo "$MNG_VLAN" > $SUBUTAI_DATA_PREFIX/vlan
fi

mkdir -p /var/run/openvswitch/
mkdir -p /var/lib/apps/subutai/current/var/subutai-network/

while [ "`ip link | grep 'wan' | wc -l`" -eq "0" ]; do
	sleep 1
	ovs-vsctl --may-exist add-br wan
done
ovs-vsctl set bridge wan other-config:hwaddr=$(ip link show eth0 | grep ether | awk '{print $2}')
ovs-vsctl --may-exist add-port wan eth0
ifconfig eth0 0 && dhclient -nw wan
for i in {1..2}; do ifconfig eth$i up && timeout 10 dhclient eth$i; done


cat <<EOF > /writable/system-data/etc/network/interfaces.d/eth0
allow-hotplug eth0
iface eth0 inet manual
EOF

dhclient -r eth0
ovs-vsctl --may-exist add-port wan mng-net -- set interface mng-net type=internal
ovs-vsctl set interface mng-net mac=$(ovs-vsctl get interface mng-net mac_in_use | tr -d '"' | sed 's/:/\\:/g')
ovs-vsctl set port mng-net tag=$MNG_VLAN

ovs-vsctl --may-exist add-br lxc-br
ovs-vsctl --may-exist add-port lxc-br nat -- set interface nat type=internal
ifconfig nat 10.10.0.254/24

iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -A POSTROUTING -t mangle -p udp --dport bootpc -j CHECKSUM --checksum-fill

ifup -a --allow=env
dhclient -nw mng-net

while true; do
	timeout 10 dhclient eth0
	if [ "$?" == "0" ]; then
		ifconfig eth0 0
		ovs-vsctl add-port wan eth0
		ovs-vsctl del-port wan eth1
		timeout 10 dhclient eth1
		ovs-vsctl set bridge wan other-config:hwaddr=$(ip link show eth0 | grep ether | awk '{print $2}')
	else
		ifconfig eth1 0
		ovs-vsctl add-port wan eth1
		ovs-vsctl del-port wan eth0
		timeout 10 dhclient eth0
		ovs-vsctl set bridge wan other-config:hwaddr=$(ip link show eth1 | grep ether | awk '{print $2}')
	fi
	timeout 10 dhclient wan

	if [ "$AUTOBUILD_IP" != "" ]; then
		if [ "$(ovs-vsctl list-ports wan | grep -c eth0)" == "1" ]; then
			IP=$(ifconfig wan | grep 'inet addr' | awk -F: '{print $2}' | awk '{print $1}')
		else
			IP=$(ifconfig eth2 | grep 'inet addr' | awk -F: '{print $2}' | awk '{print $1}')
		fi
		echo $IP | nc $AUTOBUILD_IP 48723
		AUTOBUILD_IP=""
	fi
	sleep 10
	ps aux | egrep "dhclient eth|dhclient wan" | awk '{print $2}' | xargs kill
done
